{% extends "rifas/admin/base_admin.html" %}
{% load ui_extras %}

{% block title %}Financeiro — {{ rifa.titulo }}{% endblock %}

{% block head_extra %}
<style>
  .page-head{
    display:flex;
    gap:.6rem;
    align-items:center;
    margin-bottom:1rem;
    flex-wrap:wrap;
  }
  .page-head-title{
    font-size:1.05rem;
    font-weight:600;
  }
  .btn-back{
    background:radial-gradient(circle at 20% 20%, rgba(255,255,255,.08), rgba(15,23,42,.05));
    border:1px solid rgba(148,163,184,.35);
    color:#fff !important;
    border-radius:.75rem;
    display:inline-flex;
    align-items:center;
    gap:.4rem;
    padding:.4rem .85rem .45rem;
    text-decoration:none !important;
  }
  .btn-back:hover{
    background:rgba(148,163,184,.14);
    border-color:rgba(148,163,184,.4);
  }

  .btn-action{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    gap:.35rem;
    min-height:32px;
    padding:.35rem .7rem;
    font-weight:600;
    border-radius:.65rem;
    flex:0 0 auto;
    white-space:nowrap;
    text-decoration:none !important;
  }
  .btn-config{
    background:linear-gradient(180deg,#f1c94d 0%,#d9ad2f 100%);
    border:1px solid rgba(250,204,21,.35);
    color:#111 !important;
  }
  .btn-config:hover{
    filter:brightness(1.03);
  }
  .btn-rifa{
    background:#0f766e;
    border:1px solid rgba(15,118,110,.4);
    color:#fff !important;
  }
  .btn-save{
    background:#22c55e;
    border:1px solid rgba(34,197,94,.4);
    color:#0f172a !important;
  }
  .btn-pay{
    background:#22c55e;
    border:1px solid rgba(34,197,94,.35);
    color:#0f172a !important;
    padding:.25rem .5rem;
  }

  /* mesmos painéis do resto */
  .panel{
    background:rgba(15,23,42,.35);
    border:1px solid rgba(148,163,184,.12);
    border-radius:1rem;
    margin-bottom:1rem;
  }
  .panel-h{
    padding:.85rem 1rem .55rem;
    border-bottom:1px solid rgba(148,163,184,.1);
    display:flex;
    gap:.5rem;
    align-items:center;
    justify-content:space-between;
  }
  .panel-c{ padding:1rem; }

  .kpi{
    background:rgba(15,23,42,.35);
    border:1px solid rgba(148,163,184,.12);
    border-radius:1rem;
    padding:.75rem 1rem .65rem;
  }
  .kpi .h{
    font-size:.7rem;
    text-transform:uppercase;
    letter-spacing:.04em;
    color:rgba(226,232,240,.55);
  }
  .kpi .v{
    font-size:1.35rem;
    font-weight:700;
  }

  .table-darkish.table{
    color:#e2e8f0;
  }
  .table-darkish.table thead th{
    border-bottom:1px solid rgba(148,163,184,.12);
    color:rgba(226,232,240,.65);
  }
  .badge-paid{
    background:rgba(34,197,94,.14);
    border:1px solid rgba(34,197,94,.35);
    border-radius:.5rem;
    padding:.05rem .55rem .15rem;
    font-size:.63rem;
  }
  .badge-pending{
    background:rgba(250,204,21,.08);
    border:1px solid rgba(250,204,21,.35);
    border-radius:.5rem;
    padding:.05rem .55rem .15rem;
    font-size:.63rem;
  }
  .badge-soft{
    background:rgba(15,23,42,.15);
    border:1px solid rgba(148,163,184,.04);
    border-radius:.5rem;
    padding:.05rem .6rem .15rem;
    font-size:.6rem;
  }
</style>
{% endblock %}

{% block content %}

<div class="page-head">
  <a href="{% url 'adminx_rifa_detail' rifa.id %}" class="btn-back">
    <i class="fa-solid fa-arrow-left"></i>
    Voltar
  </a>
  <div class="page-head-title">Financeiro da rifa: {{ rifa.titulo }}</div>

  <a href="{% url 'adminx_rifa_config' rifa.id %}" class="btn-action btn-config ms-auto">
    <i class="fa-solid fa-sliders"></i> Configuração
  </a>
  <a href="{% url 'adminx_rifa_detail' rifa.id %}" class="btn-action btn-rifa ms-2">
    <i class="fa-solid fa-table-cells-large"></i> Painel
  </a>
</div>

{# KPIs do topo #}
<div class="row g-3 mb-3">
  <div class="col-12 col-md-3">
    <div class="kpi">
      <div class="h">Total bruto (pagos)</div>
      <div class="v">R$ {{ total_bruto }}</div>
      <div class="small text-secondary">Tudo que entrou na rifa</div>
    </div>
  </div>
  <div class="col-12 col-md-3">
    <div class="kpi">
      <div class="h">Taxas estimadas</div>
      <div class="v text-warning">R$ {{ total_taxas }}</div>
      <div class="small text-secondary">
        {{ taxa_perc }}% + R$ {{ taxa_fixa }} × {{ qtd_pedidos_pagos }}
      </div>
    </div>
  </div>
  <div class="col-12 col-md-3">
    <div class="kpi">
      <div class="h">Líquido estimado</div>
      <div class="v text-success">R$ {{ total_liquido }}</div>
      <div class="small text-secondary">Bruto - taxas - despesas</div>
    </div>
  </div>
  <div class="col-12 col-md-3">
    <div class="kpi">
      <div class="h">Pedidos pagos</div>
      <div class="v">{{ qtd_pedidos_pagos }}</div>
      <div class="small text-secondary">Confirmados</div>
    </div>
  </div>
</div>

{# linha: form de financeiro + premiações #}
<div class="row g-3 mb-3">
  <div class="col-12 col-lg-4">
    <div class="panel">
      <div class="panel-h">
        <div><i class="fa-solid fa-gear me-2"></i>Custos e taxas da rifa</div>
      </div>
      <div class="panel-c">
        <form method="post">
          {% csrf_token %}
          <div class="mb-2">
            <label class="form-label small text-light">Custo do prêmio principal</label>
            {{ form.custo_premio }}
          </div>
          <div class="mb-2">
            <label class="form-label small text-light">Prêmio Top comprador</label>
            {{ form.premio_top_comprador }}
            <div class="small text-secondary">Se preencher, aparece uma premiação de Top.</div>
          </div>
          <div class="mb-2">
            <label class="form-label small text-light">Outras despesas</label>
            {{ form.outras_despesas }}
          </div>
          <div class="mb-2">
            <label class="form-label small text-light">Taxa admin (%)</label>
            {{ form.taxa_admin_percentual }}
            <div class="small text-secondary">0 = usa da empresa.</div>
          </div>
          <div class="mb-3">
            <label class="form-label small text-light">Taxa admin fixa (R$)</label>
            {{ form.taxa_admin_fixa }}
            <div class="small text-secondary">0 = usa da empresa.</div>
          </div>
          <button type="submit" class="btn-action btn-save w-100">
            <i class="fa-solid fa-floppy-disk"></i> Salvar
          </button>
        </form>
      </div>
    </div>

    {# se quiser mostrar top compradores também no financeiro #}
    {% if top_compradores %}
    <div class="panel">
      <div class="panel-h">
        <div><i class="fa-solid fa-ranking-star me-2"></i>Top compradores</div>
      </div>
      <div class="panel-c">
        <div class="table-responsive">
          <table class="table table-sm table-darkish mb-0">
            <thead>
              <tr>
                <th>Cliente</th>
                <th class="text-end">Qtd</th>
              </tr>
            </thead>
            <tbody>
              {% for c in top_compradores %}
              <tr>
                <td>
                  {{ c.cliente__nome }}<br>
                  <span class="text-secondary small">{{ c.cliente__cpf }}</span>
                </td>
                <td class="text-end">{{ c.qtd }}</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <p class="text-secondary small mt-2 mb-0">
          Baseado em números pagos desta rifa.
        </p>
      </div>
    </div>
    {% endif %}
  </div>

  <div class="col-12 col-lg-8">
    <div class="panel">
      <div class="panel-h">
        <div><i class="fa-solid fa-gift me-2"></i>Premiações (cotas premiadas, top comprador, manual)</div>
        <div class="text-secondary small">
          Criadas automaticamente a partir das cotas premiadas da rifa.
        </div>
      </div>
      <div class="panel-c">
        <div class="table-responsive">
          <table class="table table-sm table-darkish mb-0">
            <thead>
              <tr>
                <th>Tipo</th>
                <th>Número</th>
                <th>Cliente</th>
                <th>Descrição</th>
                <th>Valor</th>
                <th>Status</th>
                <th class="text-end">Ações</th>
              </tr>
            </thead>
            <tbody>
              {% for p in premiacoes %}
              <tr>
                <td>
                  {% if p.tipo == "cota_premiada" %}
                    <span class="badge-soft">Cota premiada</span>
                  {% elif p.tipo == "top_comprador" %}
                    <span class="badge-soft">Top comprador</span>
                  {% elif p.tipo == "principal" %}
                    <span class="badge-soft">Prêmio principal</span>
                  {% else %}
                    <span class="badge-soft">Outro</span>
                  {% endif %}
                </td>
                <td>{% if p.numero %}#{{ p.numero }}{% else %}—{% endif %}</td>
                <td>
                  {% if p.cliente %}
                    {{ p.cliente.nome }}
                  {% else %}
                    <span class="text-secondary small">—</span>
                  {% endif %}
                </td>
                <td>{{ p.descricao|default:"—" }}</td>
                <td>R$ {{ p.valor }}</td>
                <td>
                  {% if p.pago %}
                    <span class="badge-paid">pago</span><br>
                    <span class="text-secondary small">{{ p.pago_em|date:"d/m H:i" }}</span>
                  {% else %}
                    <span class="badge-pending">pendente</span>
                  {% endif %}
                </td>
                <td class="text-end">
                  {% if not p.pago %}
                  <form method="post" style="display:inline;">
                    {% csrf_token %}
                    <input type="hidden" name="pagar_premiacao_id" value="{{ p.id }}">
                    <button class="btn-pay" title="Marcar como pago">
                      <i class="fa-solid fa-check"></i>
                    </button>
                  </form>
                  {% endif %}
                </td>
              </tr>
              {% empty %}
              <tr>
                <td colspan="7" class="text-secondary">Nenhuma premiação cadastrada para esta rifa.</td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
        <p class="text-secondary small mt-2 mb-0">
          Quando você cadastra <strong>cotas premiadas</strong> na rifa, elas aparecem aqui automaticamente.
          Se tiver prêmio para <strong>top comprador</strong> e você preencheu o valor ali do lado, ele aparece aqui também.
        </p>
      </div>
    </div>
  </div>
</div>

{# resumo simples que você já tinha #}
<div class="panel">
  <div class="panel-h">
    <div><i class="fa-solid fa-coins me-2"></i>Resumo financeiro</div>
  </div>
  <div class="panel-c">
    <div class="row g-3">
      <div class="col-12 col-md-4">
        <div class="small text-secondary mb-1">Taxa percentual usada</div>
        <div class="fw-semibold">{{ taxa_perc }} %</div>
      </div>
      <div class="col-12 col-md-4">
        <div class="small text-secondary mb-1">Taxa fixa por pedido</div>
        <div class="fw-semibold">R$ {{ taxa_fixa }}</div>
      </div>
      <div class="col-12 col-md-4">
        <div class="small text-secondary mb-1">Total de taxas</div>
        <div class="fw-semibold text-warning">R$ {{ total_taxas }}</div>
      </div>
    </div>
  </div>
</div>

{# pedidos pagos #}
<div class="panel">
  <div class="panel-h">
    <div><i class="fa-solid fa-receipt me-2"></i>Pedidos pagos</div>
  </div>
  <div class="panel-c">
    <div class="table-responsive">
      <table class="table table-sm table-darkish mb-0">
        <thead>
          <tr>
            <th>Protocolo</th>
            <th>Cliente</th>
            <th>Total</th>
            <th>Status</th>
            <th>Data</th>
          </tr>
        </thead>
        <tbody>
          {% for p in pedidos_pagos %}
            <tr>
              <td>{{ p.protocolo }}</td>
              <td>{{ p.cliente.nome }}</td>
              <td>R$ {{ p.total }}</td>
              <td><span class="badge-paid">pago</span></td>
              <td>{{ p.criado_em|date:"d/m/Y H:i" }}</td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="5" class="text-secondary">Nenhum pedido pago ainda.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

{# todos os pedidos #}
<div class="panel">
  <div class="panel-h">
    <div><i class="fa-solid fa-list me-2"></i>Todos os pedidos (últimos 200)</div>
  </div>
  <div class="panel-c">
    <div class="table-responsive">
      <table class="table table-sm table-darkish mb-0">
        <thead>
          <tr>
            <th>Protocolo</th>
            <th>Cliente</th>
            <th>Total</th>
            <th>Status</th>
            <th>Data</th>
          </tr>
        </thead>
        <tbody>
          {% for p in pedidos %}
            <tr>
              <td>{{ p.protocolo }}</td>
              <td>{{ p.cliente.nome }}</td>
              <td>R$ {{ p.total }}</td>
              <td>{{ p.get_status_display }}</td>
              <td>{{ p.criado_em|date:"d/m/Y H:i" }}</td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="5" class="text-secondary">Nenhum pedido ainda.</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>
</div>

{% endblock %}
